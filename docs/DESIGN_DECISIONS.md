# Polimoney エコシステム設計方針

このドキュメントでは、Polimoney エコシステム全体の設計方針を記載します。\
3つのリポジトリ（Hub / Ledger /
Polimoney）で共通の理解を持つためのドキュメントです。

## 目次

- [開発環境のネットワーク構成](#開発環境のネットワーク構成)
- [エコシステム概要](#エコシステム概要)
- [マスターデータ管理方針](#マスターデータ管理方針)
- [登録リクエストの仕組み](#登録リクエストの仕組み)
- [証明書類の要件](#証明書類の要件)
- [データフロー](#データフロー)
- [API 設計](#api-設計)
- [管理画面の要件](#管理画面の要件)
- [各リポジトリの責務](#各リポジトリの責務)

---

## 開発環境のネットワーク構成

```
┌─────────────────────────────────────────────────────────────────┐
│                      polimoney-network                           │
│                                                                  │
│  ┌─────────────────┐                  ┌─────────────────────┐  │
│  │     Ledger      │ ──────────────── │        Hub          │  │
│  │     :3001       │                  │       :8000         │  │
│  │                 │                  │                     │  │
│  │  ┌───────────┐  │                  │  ┌───────────────┐  │  │
│  │  │ Supabase  │  │                  │  │  Admin UI     │  │  │
│  │  │  :54321   │  │                  │  │    :3002      │  │  │
│  │  └───────────┘  │                  │  └───────────────┘  │  │
│  └─────────────────┘                  └──────────┬──────────┘  │
│                                                  │              │
│                                       ┌──────────┴──────────┐  │
│                                       │     PostgreSQL      │  │
│                                       │       :5432         │  │
│                                       └─────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### ポート一覧

| サービス           | ポート | 説明                   |
| ------------------ | ------ | ---------------------- |
| Polimoney (可視化) | 3000   | 市民向けフロントエンド |
| Polimoney Ledger   | 3001   | 政治家向けアプリ       |
| Hub Admin UI       | 3002   | 運営向け管理画面       |
| Hub API            | 8000   | バックエンド API       |
| PostgreSQL         | 5432   | Hub のデータベース     |
| Supabase           | 54321  | Ledger のバックエンド  |

---

## エコシステム概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Polimoney エコシステム                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        Polimoney Hub                              │  │
│  │  - マスターデータ管理（選挙・政治団体）                           │  │
│  │  - 共通識別子の発行                                               │  │
│  │  - 登録リクエストの受付・承認                                     │  │
│  │  - データ連携・匿名化                                             │  │
│  └───────────────────────────┬──────────────────────────────────────┘  │
│                              │                                          │
│          ┌───────────────────┼───────────────────┐                     │
│          │                   │                   │                     │
│          ▼                   ▼                   ▼                     │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐            │
│  │ Polimoney     │   │ Azure DB      │   │ Polimoney     │            │
│  │ Ledger        │   │ (white)       │   │ (可視化)      │            │
│  │               │   │               │   │               │            │
│  │ 政治家向け    │   │ マスタDB      │   │ 市民向け      │            │
│  │ 収支管理      │   │               │   │ 可視化        │            │
│  └───────────────┘   └───────────────┘   └───────────────┘            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### リポジトリ一覧

| リポジトリ                                                          | 役割                     | 技術スタック                   |
| ------------------------------------------------------------------- | ------------------------ | ------------------------------ |
| [polimoney-hub](https://github.com/your-org/polimoney-hub)          | データハブ・マスター管理 | Deno + Hono + Azure PostgreSQL |
| [polimoney_ledger](https://github.com/moai-redcap/polimoney_ledger) | 政治資金収支管理         | Supabase                       |
| [polimoney](https://github.com/digitaldemocracy2030/polimoney)      | 政治資金可視化           | (Frontend)                     |

---

## マスターデータ管理方針

### 基本方針: すべて事前登録制

**理由:**

- 複数ユーザーが同時に同じデータを登録すると、重複が発生する
- 入力ミス（表記揺れ）により、同じ実体に複数のIDが割り当てられる
- データの正確性・一意性を保証するため、運営が管理する

### マスターデータの種類

| データ                   | 管理方針            | 登録者                         |
| ------------------------ | ------------------- | ------------------------------ |
| **選挙**                 | 事前登録            | 運営（公的情報からインポート） |
| **政治団体（政党）**     | 事前登録            | 運営                           |
| **政治団体（後援会等）** | 事前登録            | 運営（リクエストに基づき登録） |
| **政治家**               | Ledger 登録時に発行 | Hub が自動発行                 |

### Ledger ユーザーの操作

```
【選挙・政治団体を選択する場合】

┌─────────────────────────────────────────────────────┐
│ 対象選挙を選択                                       │
├─────────────────────────────────────────────────────┤
│  [▼ 選択してください                              ] │
│  ┌────────────────────────────────────────────────┐ │
│  │ 🔍 検索...                                     │ │
│  ├────────────────────────────────────────────────┤ │
│  │ 📅 2024年                                      │ │
│  │   └ 第50回衆議院議員総選挙                     │ │
│  │       ├ 東京1区                                │ │
│  │       ├ 東京2区                                │ │
│  │       └ ...                                    │ │
│  ├────────────────────────────────────────────────┤ │
│  │ ⚠️ 該当する選挙がない場合                      │ │
│  │   → [登録をリクエスト]                         │ │
│  └────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 登録リクエストの仕組み

### フロー概要

```
Ledger ユーザー                Hub                     運営
      │                         │                       │
      │ 1. 該当データがない      │                       │
      │                         │                       │
      │ 2. リクエスト送信        │                       │
      │    (証明書類添付)        │                       │
      ├────────────────────────▶│                       │
      │                         │                       │
      │                         │ 3. リクエスト保存      │
      │                         ├──────────────────────▶│
      │                         │                       │
      │                         │       4. 確認・承認    │
      │                         │◀──────────────────────┤
      │                         │                       │
      │                         │ 5. マスターデータ作成  │
      │                         │                       │
      │ 6. 通知（承認完了）      │                       │
      │◀────────────────────────│                       │
      │                         │                       │
      │ 7. 選択可能になる        │                       │
```

### リクエストのステータス

| ステータス   | 説明                               |
| ------------ | ---------------------------------- |
| `pending`    | 審査待ち                           |
| `approved`   | 承認済み（マスターデータ作成完了） |
| `rejected`   | 却下（理由付き）                   |
| `needs_info` | 追加情報が必要                     |

---

## 証明書類の要件

### 政治団体の証明

政治団体を登録リクエストする際は、以下のいずれかの証明書類が必要です。

| 証明書類                             | 説明                                  | 優先度        |
| ------------------------------------ | ------------------------------------- | ------------- |
| **政治団体設立届出書（控え）**       | 選管から受け取った届出書のコピー      | ⭐⭐⭐ 最優先 |
| **政治団体名簿のスクリーンショット** | 総務省/選管サイトに掲載されている名簿 | ⭐⭐          |
| **政治資金収支報告書の表紙**         | 団体名と届出番号が確認できるもの      | ⭐⭐          |

### 選挙の証明

選挙は公的情報として確認可能なため、証明書類は任意です。

| 証明書類           | 説明               |
| ------------------ | ------------------ |
| 選管サイトの URL   | 告示情報など       |
| ニュース記事の URL | 選挙日程の報道など |

### ファイルの保存先

```
Ledger (Supabase Storage)              Hub (Azure)
        │                                   │
        │ 1. 証明書類をアップロード          │
        ▼                                   │
   Supabase Storage                         │
        │                                   │
        │ 2. 公開 URL を取得                 │
        │                                   │
        └──────────────────────────────────▶│
           POST /api/v1/organization-requests
           { evidence_file_url: "https://..." }
                                            │
                                            ▼
                              organization_requests テーブル
```

---

## データフロー

### 1. 初回登録（政治家 ID 発行）

```
政治家（Ledger 新規登録）
        │
        │ 1. Supabase Auth でサインアップ
        ▼
   Ledger Backend
        │
        │ 2. Hub に政治家 ID 発行をリクエスト
        ▼
   Hub API: POST /api/v1/politicians
        │
        │ 3. UUID を発行
        ▼
   Azure DB (politicians テーブル)
        │
        │ 4. 政治家 ID を返却
        ▼
   Ledger（politician_id を保存）
```

### 2. 台帳作成

```
政治家（Ledger で台帳作成）
        │
        │ 1. 選挙を選択（Hub API から取得したリスト）
        │ 2. 政治団体を選択（Hub API から取得したリスト）
        ▼
   Ledger（台帳データ作成）
        │
        │ 3. election_id, organization_id を紐付け
        ▼
   Supabase DB（ledger テーブル）
```

### 3. 公開データ同期

```
Ledger DB (Supabase)
        │
        │ Supabase Realtime (変更検知)
        ▼
   Hub (Webhook / Realtime Listener)
        │
        │ 1. 匿名化処理
        │ 2. ハッシュ生成
        │ 3. 変更履歴記録
        ▼
   Azure DB (public_ledgers, public_journals)
        │
        ▼
   Polimoney（可視化サービス）が参照
```

---

## API 設計

### Hub API エンドポイント

#### マスターデータ取得（認証不要 or Ledger 用）

| メソッド | エンドポイント              | 説明         |
| -------- | --------------------------- | ------------ |
| GET      | `/api/v1/elections`         | 選挙一覧     |
| GET      | `/api/v1/elections/:id`     | 選挙詳細     |
| GET      | `/api/v1/organizations`     | 政治団体一覧 |
| GET      | `/api/v1/organizations/:id` | 政治団体詳細 |
| GET      | `/api/v1/politicians`       | 政治家一覧   |
| GET      | `/api/v1/politicians/:id`   | 政治家詳細   |

#### 登録リクエスト（Ledger → Hub）

| メソッド | エンドポイント                      | 説明                   |
| -------- | ----------------------------------- | ---------------------- |
| POST     | `/api/v1/election-requests`         | 選挙登録リクエスト     |
| GET      | `/api/v1/election-requests`         | 自分のリクエスト一覧   |
| GET      | `/api/v1/election-requests/:id`     | リクエスト詳細         |
| POST     | `/api/v1/organization-requests`     | 政治団体登録リクエスト |
| GET      | `/api/v1/organization-requests`     | 自分のリクエスト一覧   |
| GET      | `/api/v1/organization-requests/:id` | リクエスト詳細         |

#### 管理者用（運営 → Hub）

**認証:** `X-Admin-Key` ヘッダー

| メソッド | エンドポイント                                 | 説明               |
| -------- | ---------------------------------------------- | ------------------ |
| GET      | `/api/admin/election-requests`                 | 全リクエスト一覧   |
| PUT      | `/api/admin/election-requests/:id/approve`     | 承認               |
| PUT      | `/api/admin/election-requests/:id/reject`      | 却下               |
| GET      | `/api/admin/organization-requests`             | 全リクエスト一覧   |
| PUT      | `/api/admin/organization-requests/:id/approve` | 承認               |
| PUT      | `/api/admin/organization-requests/:id/reject`  | 却下               |
| POST     | `/api/admin/elections`                         | 選挙を直接登録     |
| POST     | `/api/admin/organizations`                     | 政治団体を直接登録 |

---

## 管理画面の要件

### 必要な機能

1. **リクエスト一覧表示**
   - ステータス別フィルタ（保留中 / 承認済 / 却下）
   - 日付順ソート

2. **リクエスト詳細表示**
   - 申請内容の確認
   - 証明書類のプレビュー

3. **承認・却下操作**
   - 承認 → マスターデータ自動作成
   - 却下 → 理由の入力必須

4. **マスターデータ直接登録**
   - 運営による事前登録
   - 一括インポート機能（CSV）

### UI モックアップ

```
┌─────────────────────────────────────────────────────────────────┐
│ Polimoney Hub 管理画面                           [ログアウト]   │
├─────────────────────────────────────────────────────────────────┤
│ 📋 ダッシュボード │ 🗳️ 選挙 │ 🏛️ 政治団体 │ 📨 リクエスト     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 📨 登録リクエスト                                               │
│                                                                  │
│ [🔴 保留中 (3)] [✅ 承認済 (25)] [❌ 却下 (2)]                  │
│                                                                  │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 🏛️ 山田太郎後援会                            2024/12/13    │ │
│ │    種別: 後援会                                              │ │
│ │    届出先: 東京都選挙管理委員会                              │ │
│ │    申請者: 山田太郎 (politician_id: xxx)                     │ │
│ │                                                              │ │
│ │    📎 証明書類: 政治団体設立届出書                           │ │
│ │    [📄 プレビュー]                                           │ │
│ │                                                              │ │
│ │    [✅ 承認] [❌ 却下] [💬 追加情報を要求]                   │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 🗳️ 〇〇市議会議員選挙                        2024/12/12    │ │
│ │    種別: GM (議会選挙)                                       │ │
│ │    選挙日: 2025/04/20                                        │ │
│ │    申請者: 佐藤花子 (politician_id: yyy)                     │ │
│ │                                                              │ │
│ │    📎 証明: https://city.example.jp/election/...             │ │
│ │                                                              │ │
│ │    [✅ 承認] [❌ 却下]                                       │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 技術選定（提案）

| 選択肢                           | メリット        | デメリット                  |
| -------------------------------- | --------------- | --------------------------- |
| **Hub に組み込み（Hono + JSX）** | 別デプロイ不要  | Hono での管理画面は複雑     |
| **別途 SPA（React/Vue）**        | UI の自由度高い | 別リポジトリ/デプロイが必要 |
| **Retool / Adminjs 等**          | 開発コスト低    | 外部サービス依存            |

**推奨: Hub リポジトリ内に `/admin` として React SPA を配置**

---

## 各リポジトリの責務

### polimoney-hub

- [x] 共通識別子 API（政治家 / 政治団体 / 選挙）
- [x] API Key 認証
- [ ] 登録リクエスト API
- [ ] 管理者用 API
- [ ] 管理画面（SPA）
- [ ] 公開データ永続化（public_ledgers 等）
- [ ] Supabase Realtime 連携

### polimoney_ledger

- [ ] Hub API との連携
  - [ ] 選挙一覧取得・選択 UI
  - [ ] 政治団体一覧取得・選択 UI
  - [ ] 登録リクエスト送信機能
  - [ ] 証明書類アップロード
- [ ] 政治家 ID の Hub 連携
- [ ] 台帳公開時の Hub 通知

### polimoney（可視化）

- [ ] Hub API からの公開データ取得
- [ ] 変更履歴の表示
- [ ] 改ざん検知の表示

---

## 次のステップ

### Phase 1: Hub 基盤拡張

1. 登録リクエスト用テーブル追加
2. リクエスト API 実装
3. 管理者 API 実装

### Phase 2: 管理画面

1. 管理画面 SPA 構築
2. リクエスト承認フロー実装
3. マスターデータ直接登録機能

### Phase 3: Ledger 連携

1. Hub API クライアント実装
2. 選挙・政治団体選択 UI
3. 登録リクエスト機能

### Phase 4: データ同期

1. Supabase Realtime 連携
2. 公開データ永続化
3. 変更履歴記録

---

## 更新履歴

| 日付       | 内容                                                           |
| ---------- | -------------------------------------------------------------- |
| 2024-12-13 | 初版作成（マスターデータ事前登録方針、登録リクエストの仕組み） |
